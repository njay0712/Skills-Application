<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sozo Skills Training Application</title>
    <style>
        :root {
            /* Branding colors */
            --primary: #667eea; /* Blue-Violet */
            --secondary: #764ba2; /* Darker Purple */
            --accent: #c7d2fe;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --success: #10b981;
            --warning-bg: #fef3c7;
            --warning-border: #f59e0b;
            --warning-text: #b45309;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            color: white;
            animation: fadeIn 1s ease-out;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        p.subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .application-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 6px solid var(--primary);
        }

        .card h2 {
            margin-top: 0;
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 20px;
            border-bottom: 2px dashed var(--accent);
            padding-bottom: 10px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        /* Input and Select Styling */
        input:not([type="radio"]), select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
            margin-bottom: 15px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Conditional Groups */
        .id-type-selection { display: flex; gap: 20px; margin-bottom: 15px; }
        .id-type-selection label { display: inline-flex; align-items: center; font-weight: 400; margin-bottom: 0; }
        .id-type-selection input[type="radio"] { width: auto; margin-right: 8px; margin-bottom: 0; }
        .conditional-section { 
            border: 1px dashed #e0e7ff; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
        }
        .required { color: #e74c3c; }

        /* Program Info Box Styling */
        #programInfoBox .program-detail-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #eef2ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid var(--primary);
            text-align: center;
        }

        #programInfoBox .program-detail-card img {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #programInfoBox .program-detail-card h3 {
            color: var(--secondary);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        #programInfoBox .program-detail-card p {
            color: #475569;
            margin-bottom: 0;
        }

        /* Assessment Rating Group */
        .rating-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 5px 0;
            border-top: 1px dashed #eee;
        }
        .rating-group label {
            font-weight: 400;
            font-size: 1em;
            margin-bottom: 0;
        }
        .rating-group select {
            width: 150px;
            margin-bottom: 0;
        }
        
        /* IMPORTANT NOTE STYLING */
        .important-note {
            background-color: var(--warning-bg); 
            color: var(--warning-text); 
            border-left: 5px solid var(--warning-border);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
        }
        .important-note strong {
            font-weight: 700;
            color: #c084f0; /* Use a strong color for emphasis */
        }
        
        /* Submission Styles */
        .submit-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 18px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
            width: 100%;
        }

        .submit-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Success Message */
        #success-message {
            display: none;
            text-align: center;
            padding: 40px;
            background: #dcfce7;
            color: #166534;
            border-radius: 16px;
            margin-top: 20px;
            border-left: 6px solid var(--success);
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #success-message h2 { color: var(--success); }
        .summary-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #e0e0e0;
        }
        .summary-label { font-weight: 600; color: #475569; }
        .summary-value { color: var(--primary); font-weight: 500; }
        /* Highlighted ID on Success Screen */
        .summary-item.highlight {
            background-color: #f0f4ff; /* Light accent blue */
            padding: 15px 10px;
            border-radius: 8px;
            border: 1px solid #c7d2fe;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        .id-value {
            color: var(--secondary);
            font-weight: 700;
        }


        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ðŸŽ“ Sozo Skills Application</h1>
            <p class="subtitle">Complete the form and assessment below to apply for a training program.</p>
        </header>

        <form name="fullApplicationForm" class="application-form" id="fullApplicationForm">
            
            <div class="card">
                <h2>1. Personal Information</h2>
                <div class="form-group"><label>First Name <span class="required">*</span></label><input type="text" name="firstName" required></div>
                <div class="form-group"><label>Last Name <span class="required">*</span></label><input type="text" name="lastName" required></div>
                
                <div class="form-group">
                    <label>Identification Type <span class="required">*</span></label>
                    <div class="id-type-selection">
                        <label><input type="radio" name="identificationType" value="SA ID" required onclick="toggleIdentificationType(this)">South African ID</label>
                        <label><input type="radio" name="identificationType" value="Passport" required onclick="toggleIdentificationType(this)">Passport / Foreign ID</label>
                    </div>
                </div>

                <div class="conditional-section" id="saIdGroup" style="display: none;">
                    <label>South African ID Number <span class="required">*</span></label>
                    <input type="text" name="idNumber" id="idNumberInput" pattern="[0-9]{13}" placeholder="13-digit ID number" oninput="processSAID(this)">
                </div>

                <div class="conditional-section" id="passportGroup" style="display: none;">
                    <label>Passport Number <span class="required">*</span></label>
                    <input type="text" name="passportNumber" id="passportNumberInput">
                    <div style="border-left: 3px solid #f39c12; padding-left: 10px; margin-top: 15px;">
                        <label style="font-weight: 700;">Do you have a valid Work or Study Permit? <span class="required">*</span></label>
                        <select name="permitStatus" id="permitStatusInput" onchange="togglePermitDetails(this)">
                            <option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option>
                        </select>
                        <div class="form-group" id="permitDetailsGroup" style="display: none;">
                            <label>Permit Details (e.g., Permit Type, Expiry Date)</label>
                            <input type="text" name="permitDetails">
                        </div>
                    </div>
                </div>

                <div class="form-group"><label>Date of Birth <span class="required">*</span></label><input type="date" name="dateOfBirth" id="dateOfBirthInput" required readonly style="background-color: #eee;"></div>
                <div class="form-group"><label>Age <span class="required">*</span></label><input type="number" name="age" id="ageInput" required min="16" max="65" readonly style="background-color: #eee;"></div>
                <div class="form-group"><label>Gender <span class="required">*</span></label><select name="gender" required onchange="toggleConstructionExperience(this)"><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
                
                <div class="conditional-section" id="constructionExperienceSection" style="display: none;">
                    <label>Do you have any experience in construction or related trades?</label>
                    <select name="constructionExperience" onchange="toggleConstructionDetails(this)"><option value="No">No</option><option value="Yes">Yes</option></select>
                    <div class="form-group" id="constructionDetailsGroup" style="display: none; margin-top: 15px;">
                        <label>Please briefly describe your experience</label><textarea name="constructionDetails" rows="2"></textarea>
                    </div>
                </div>

                <div class="form-group"><label>Race <span class="required">*</span></label><select name="race" required><option value="">Select Race</option><option value="African">African</option><option value="Coloured">Coloured</option><option value="Indian">Indian</option><option value="White">White</option><option value="Other">Other</option></select></div>
                <div class="form-group"><label>Do you have a disability? <span class="required">*</span></label><select name="disability" required onchange="toggleDisabilityType(this)"><option value="">Select</option><option value="No">No</option><option value="Yes">Yes</option></select></div>
                <div class="form-group" id="disabilityTypeGroup" style="display: none;"><label>Type of Disability</label><input type="text" name="disabilityType"></div>
            </div>

            <div class="card" style="border-left-color: #f59e0b;">
                <h2 style="color: #f59e0b;">2. Contact & Background</h2>
                <div class="form-group"><label>Mobile Number <span class="required">*</span></label><input type="tel" name="mobile" required pattern="[0-9]{10}" placeholder="082xxxxxxx"></div>
                <div class="form-group"><label>Alternative Mobile Number</label><input type="tel" name="altMobile" pattern="[0-9]{10}"></div>
                <div class="form-group"><label>Email Address</label><input type="email" name="email"></div>
                <div class="form-group"><label>Area <span class="required">*</span></label><select name="area" required><option value="">Select Area</option><option value="Vrygrond">Vrygrond</option><option value="Muizenberg">Muizenberg</option><option value="Lakeside">Steenberg</option><option value="Ocean View">Lavender Hill</option><option value="Fish Hoek">Grassy Park</option><option value="Ocean View">Cadfa</option><option value="Fish Hoek">Retreat</option><option value="Ocean View">Seawinds</option><option value="Fish Hoek">Hillview</option></select></div>
                <div class="form-group"><label>Full Address <span class="required">*</span></label><textarea name="address" rows="3" required></textarea></div>
                
                <h3 style="color: #667eea; margin-top: 25px; margin-bottom: 15px;">Education & Employment</h3>
                <div class="form-group"><label>Highest Education Level <span class="required">*</span></label><select name="education" required><option value="">Select</option><option value="Primary School">Primary School</option><option value="Grade 9">Grade 9</option><option value="Grade 10">Grade 10</option><option value="Grade 11">Grade 11</option><option value="Matric">Matric</option><option value="Tertiary">Tertiary</option></select></div>
                <div class="form-group"><label>Current Employment Status <span class="required">*</span></label><select name="employmentStatus" required><option value="">Select</option><option value="Unemployed">Unemployed</option><option value="Employed - Full Time">Employed - Full Time</option><option value="Employed - Part Time">Employed - Part Time</option><option value="Self-Employed">Self-Employed</option><option value="Student">Student</option></select></div>
                <div class="form-group"><label>Monthly Household Income (R) <span class="required">*</span></label><select name="income" required><option value="">Select Income Bracket</option><option value="0-R1000">R0 - R1,000</option><option value="R1001-R3000">R1,001 - R3,000</option><option value="R3001-R5000">R3,001 - R5,000</option><option value="R5001+">R5,001+</option></select></div>
                <div class="form-group"><label>Which program are you applying for? <span class="required">*</span></label><select name="program" required onchange="displayProgramInfo(this)"><option value="">Select Program</option><option value="Artisan Baking">Artisan Baking</option><option value="Barista">Barista</option><option value="Hair">Hair</option><option value="Beauty">Beauty</option></select></div>
                <div id="programInfoBox"></div>
            </div>
            
            <div class="card" style="border-left-color: #10b981;">
                <h2 style="color: #10b981;">3. Pre-Training Assessment</h2>
                
                <h3 style="color: #764ba2; margin-bottom: 15px;">Skills & Experience</h3>
                <div class="form-group">
                    <label>Technical learning ability (1-5) <span class="required">*</span></label>
                    <select name="technicalKnowledge" required><option value="">Select</option><option value="1">1 - Very Low</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5 - Excellent</option></select>
                </div>
                <div class="form-group"><label>Experience with relevant tools <span class="required">*</span></label><textarea name="toolsExperience" rows="3" required></textarea></div>
                <div class="form-group"><label>Other existing skills <span class="required">*</span></label><textarea name="existingSkills" rows="3" required></textarea></div>
                
                <h3 style="color: #764ba2; margin-top: 25px; margin-bottom: 15px;">Soft Skills (1-5)</h3>
                <div class="form-group">
                    <label>Self-Assessment (1-5):</label>
                    <div class="rating-group"><label>Following instructions</label><select name="followInstructions" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                    <div class="rating-group"><label>Time management</label><select name="timeManagement" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                    <div class="rating-group"><label>Teamwork</label><select name="teamwork" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                    <div class="rating-group"><label>Customer communication</label><select name="customerCommunication" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                    <div class="rating-group"><label>Asking for help</label><select name="askingHelp" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                </div>

                <div class="form-group"><label>Languages spoken</label><textarea name="languages" rows="2"></textarea></div>
                
                <h3 style="color: #764ba2; margin-top: 25px; margin-bottom: 15px;">Motivation & Support</h3>
                <div class="form-group"><label>Own a smartphone? <span class="required">*</span></label><select name="smartphone" required><option value="">Select</option><option value="Yes">Yes</option><option value="No">No</option></select></div>
                <div class="form-group"><label>Social media comfort (1-5) <span class="required">*</span></label><select name="socialMedia" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                <div class="form-group"><label>Computer use frequency <span class="required">*</span></label><select name="computerUse" required><option value="">Select</option><option value="Never">Never</option><option value="Rarely">Rarely</option><option value="Weekly">Weekly</option><option value="Daily">Daily</option></select></div>
                <div class="form-group"><label>Employment importance (1-5) <span class="required">*</span></label><select name="employmentImportance" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                <div class="form-group"><label>Interest in starting business? <span class="required">*</span></label><select name="businessInterest" required><option value="">Select</option><option value="Yes">Yes</option><option value="Maybe">Maybe</option><option value="No">No</option></select></div>
                <div class="form-group"><label>Commitment to complete program (1-5) <span class="required">*</span></label><select name="commitment" required><option value="">Select</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
                
                <div class="form-group"><label>Main goals after training <span class="required">*</span></label><textarea name="goals" rows="3" required></textarea></div>
                <div class="form-group"><label>Anticipated challenges <span class="required">*</span></label><textarea name="challenges" rows="3" required></textarea></div>
                <div class="form-group"><label>Support needed <span class="required">*</span></label><textarea name="supportNeeds" rows="3" required></textarea></div>
                <div class="form-group"><label>Family support level <span class="required">*</span></label><select name="familySupport" required><option value="">Select</option><option value="Fully Supportive">Fully Supportive</option><option value="Mostly Supportive">Mostly Supportive</option><option value="Neutral">Neutral</option><option value="Not Supportive">Not Supportive</option></select></div>

            </div>

            <div class="important-note">
                <strong>CRITICAL:</strong> Upon clicking 'Submit', you will receive an **Application ID**. You **must save this ID** immediately. It is required for all follow-up inquiries regarding your application status.
            </div>

            <button type="submit" class="submit-btn" id="submitBtn">
                <span id="btn-text">Submit Full Application</span>
                <div class="loader" id="loader"></div>
            </button>
        </form>

        <div id="success-message">
            <h2>Application Received! ðŸŽ‰</h2>
            
            <h3 style="color: var(--secondary); margin-top: 15px;">Please save the following ID for follow-up:</h3>

            <div class="summary-box">
                <div class="summary-item highlight">
                    <span class="summary-label" style="font-size: 1.1em;">Your Application ID:</span>
                    <span class="summary-value id-value" id="finalId" style="font-size: 1.1em;"></span>
                </div>
                <div class="summary-item"><span class="summary-label">Name:</span><span class="summary-value" id="finalName"></span></div>
                <div class="summary-item"><span class="summary-label">Program:</span><span class="summary-value" id="finalProgram"></span></div>
                <div class="summary-item"><span class="summary-label">Baseline Score:</span><span class="summary-value" id="finalScore"></span></div>
            </div>
            
            <p style="margin-top: 20px;">We will contact you via phone or email soon.</p>
            <a href="https://sozo.org.za/" class="submit-btn" style="background: #27ae60; text-decoration: none; display: block; max-width: 300px; margin: 20px auto 0;">Go to Sozo Website</a>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // *** IMPORTANT: REPLACE THIS URL WITH YOUR DEPLOYED GOOGLE APPS SCRIPT URL ***
        // ---------------------------------------------------------
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwPN_tOKWDjjHZxtlqnDkiZ_yAhfFTKy5XxVNYMZfeSvaAf3hflytuR1_paj1ZLBpHHw/exec'; 
        // ---------------------------------------------------------
        
        const PROGRAM_DETAILS = {
            "Artisan Baking": { 
                name: "Artisan Baking School", 
                image: "https://sozo.org.za/wp-content/uploads/2024/03/Skills-Training-Programme-at-Sozo-Foundation.webp", 
                description: "Hands-on training in techniques, cake decoration, and confectionery production." 
            },
            "Barista": { 
                name: "Barista School", 
                image: "https://sozo.org.za/wp-content/uploads/2024/02/Sozo-Website-Portrait-Photos-800-x-900-px.webp", 
                description: "Learn the intricacies of brewing, roasting beans, and latte art." 
            },
            "Hair": { 
                name: "Hairdressing School", 
                image: "https://sozo.org.za/wp-content/uploads/2024/02/Sozo-Foundation-Skills-Training-Programmes-3.webp", 
                description: "Expertise in washing, blow-drying, colouring, and cutting." 
            },
            "Beauty": { 
                name: "Beauty School", 
                image: "https://sozo.org.za/wp-content/uploads/2024/02/Sozo-Foundation-Skills-Training-Programmes-4.webp", 
                description: "Training in skincare, make-up artistry, and nail technology." 
            }
        };

        // Utility Functions
        function getCentury(yearString) { return parseInt(yearString) > (new Date().getFullYear() % 100) ? 1900 + parseInt(yearString) : 2000 + parseInt(yearString); }
        function calculateAge(dob) { const today = new Date(); const birthDate = new Date(dob); let age = today.getFullYear() - birthDate.getFullYear(); const m = today.getMonth() - birthDate.getMonth(); if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--; return age; }
        
        // --- Conditional Logic Functions ---
        function processSAID(input) {
            const idNumber = input.value.trim();
            const dobInput = document.getElementById('dateOfBirthInput');
            const ageInput = document.getElementById('ageInput');
            const genderSelect = document.querySelector('[name="gender"]');
            
            // Clear previous values
            dobInput.value = ''; ageInput.value = ''; genderSelect.value = ''; toggleConstructionExperience(genderSelect);
            
            if (idNumber.length === 13 && /^\d{13}$/.test(idNumber)) {
                const year = idNumber.substring(0, 2); const month = idNumber.substring(2, 4); const day = idNumber.substring(4, 6);
                const fullYear = getCentury(year); const dobString = `${fullYear}-${month}-${day}`; const dateCheck = new Date(dobString);
                
                if (dateCheck.getFullYear() === fullYear && dateCheck.getMonth() === parseInt(month) - 1) {
                    const age = calculateAge(dobString);
                    if (age >= 16 && age <= 65) {
                        dobInput.value = dobString; ageInput.value = age;
                        genderSelect.value = parseInt(idNumber.substring(10, 11)) >= 5 ? 'Male' : 'Female';
                        toggleConstructionExperience(genderSelect);
                    } else alert(`ID valid, but age (${age}) is outside required range (16-65).`);
                } else alert('Invalid date of birth extracted from ID number.');
            }
        }

        function toggleIdentificationType(radio) {
            const isSAID = radio.value === 'SA ID';
            const dobInput = document.getElementById('dateOfBirthInput');
            const ageInput = document.getElementById('ageInput');

            document.getElementById('saIdGroup').style.display = isSAID ? 'block' : 'none';
            document.getElementById('passportGroup').style.display = isSAID ? 'none' : 'block';
            document.getElementById('idNumberInput').required = isSAID;
            document.getElementById('passportNumberInput').required = !isSAID;
            document.getElementById('permitStatusInput').required = !isSAID;
            
            // Toggle Readonly and background for DOB/Age
            dobInput.readOnly = isSAID;
            ageInput.readOnly = isSAID;
            dobInput.style.backgroundColor = isSAID ? '#eee' : 'white';
            ageInput.style.backgroundColor = isSAID ? '#eee' : 'white';

            // Clear opposite fields
            if(!isSAID) { 
                document.getElementById('idNumberInput').value = ''; 
                // Manual entry is needed for non-SA ID, so clear fields if user switches
                dobInput.value = ''; 
                ageInput.value = ''; 
            } else { 
                document.getElementById('passportNumberInput').value = ''; 
                document.getElementById('permitStatusInput').value = ''; 
                document.querySelector('[name="permitDetails"]').value = ''; 
                togglePermitDetails(document.getElementById('permitStatusInput')); 
            }
        }

        // Attach date calculation to manual DOB input (if SA ID is not selected)
        document.getElementById('dateOfBirthInput').addEventListener('change', (e) => {
            if (e.target.value && !e.target.readOnly) {
                const age = calculateAge(e.target.value);
                document.getElementById('ageInput').value = age;
            }
        });
        
        function togglePermitDetails(select) {
            const group = document.getElementById('permitDetailsGroup');
            group.style.display = select.value === 'Yes' ? 'block' : 'none';
            group.querySelector('input').required = select.value === 'Yes';
            if (select.value !== 'Yes') group.querySelector('input').value = '';
        }

        function toggleDisabilityType(select) { document.getElementById('disabilityTypeGroup').style.display = select.value === 'Yes' ? 'block' : 'none'; if (select.value !== 'Yes') document.querySelector('[name="disabilityType"]').value = ''; }
        function toggleConstructionExperience(select) { 
            const isMale = select.value === 'Male';
            document.getElementById('constructionExperienceSection').style.display = isMale ? 'block' : 'none';
            if (!isMale) { document.querySelector('[name="constructionExperience"]').value = 'No'; toggleConstructionDetails(document.querySelector('[name="constructionExperience"]')); }
        }
        function toggleConstructionDetails(select) { 
            const group = document.getElementById('constructionDetailsGroup');
            group.style.display = select.value === 'Yes' ? 'block' : 'none'; 
            group.querySelector('textarea').required = select.value === 'Yes';
            if (select.value !== 'Yes') group.querySelector('textarea').value = ''; 
        }

        function displayProgramInfo(select) {
            const infoBox = document.getElementById('programInfoBox');
            if (select.value && PROGRAM_DETAILS[select.value]) {
                const p = PROGRAM_DETAILS[select.value];
                infoBox.innerHTML = `
                    <div class="program-detail-card">
                        <img src="${p.image}" alt="${p.name} image">
                        <h3>${p.name}</h3>
                        <p>${p.description}</p>
                    </div>`;
            } else { infoBox.innerHTML = ''; }
        }

        // --- Submission Handler ---
        document.getElementById('fullApplicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = this;
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btn-text');
            const loader = document.getElementById('loader');

            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            const formData = new FormData(form);
            const data = {};
            
            // 1. Collect Data
            formData.forEach((value, key) => { data[key] = value; });

            // 2. Clean/Finalize Conditional Fields
            if (data.identificationType === 'SA ID') { delete data.passportNumber; delete data.permitStatus; delete data.permitDetails; }
            else { delete data.idNumber; if (data.permitStatus === 'No') data.permitDetails = 'No permit held'; }
            if (data.gender !== 'Male') { data.constructionExperience = 'N/A'; data.constructionDetails = 'N/A'; }
            else if (data.constructionExperience === 'No') data.constructionDetails = 'None described';
            if (data.disability === 'No') data.disabilityType = 'N/A';


            // 3. Finalize Submission Metadata
            data.id = 'SS-' + Date.now().toString().slice(-8); // Generate ID
            data.submissionDate = new Date().toLocaleString();
            data.applicationStatus = 'Assessment Completed';
            data.assessmentCompleted = 'YES';
            data.type = 'full_submission'; // Tag for script

            // 4. Calculate Baseline Score
            let scoreSum = 0, scoreCount = 0;
            const scoreFields = ['technicalKnowledge', 'followInstructions', 'timeManagement', 'teamwork', 'customerCommunication', 'askingHelp', 'socialMedia', 'employmentImportance', 'commitment'];

            scoreFields.forEach(key => {
                const score = parseInt(data[key]);
                if (!isNaN(score)) { scoreSum += score; scoreCount++; }
            });

            data.baselineScore = scoreCount > 0 ? (scoreSum / scoreCount).toFixed(2) : 'N/A';
            const avgScore = data.baselineScore;


            try {
                // *** FIX: Use text/plain to avoid CORS Preflight error ***
                const response = await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify(data), 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' } 
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // 5. Success: Hide form, show summary
                    form.style.display = 'none';
                    document.getElementById('finalId').innerText = data.id;
                    document.getElementById('finalName').innerText = `${data.firstName} ${data.lastName}`;
                    document.getElementById('finalProgram').innerText = data.program;
                    document.getElementById('finalScore').innerText = `${avgScore}/5.0`;
                    document.getElementById('success-message').style.display = 'block';
                    window.scrollTo(0, 0);

                } else {
                    throw new Error(result.message || 'Submission failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Submission error: Failed to fetch. Please check your connection and ensure the SCRIPT_URL is correct.');
                btnText.style.display = 'block';
                loader.style.display = 'none';
                submitBtn.disabled = false;
            }
        });

        // Initialize display on load
        document.addEventListener('DOMContentLoaded', () => {
            // Check if any radio is selected to show conditional fields on load (useful for browser refresh)
            const idTypeSelected = document.querySelector('input[name="identificationType"]:checked');
            if (idTypeSelected) toggleIdentificationType(idTypeSelected);
            
            const genderSelected = document.querySelector('select[name="gender"]');
            if (genderSelected.value) toggleConstructionExperience(genderSelected);

            const disabilitySelected = document.querySelector('select[name="disability"]');
            if (disabilitySelected.value) toggleDisabilityType(disabilitySelected);
        });
    </script>
</body>
</html>

